/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Pipe } from '@angular/core';
import { DomSanitizer } from '@angular/platform-browser';
import { GtHighlightPipe } from './gt-highlight.pipe';
// unsupported: template constraints.
/**
 * @template R
 */
var GtRenderPipe = /** @class */ (function () {
    function GtRenderPipe(sanitizer, gtHighlightPipe) {
        this.sanitizer = sanitizer;
        this.gtHighlightPipe = gtHighlightPipe;
        /**
         * Sort by column order
         */
        this.getColumnOrder = function (a, b) {
            if (a.columnOrder < b.columnOrder) {
                return -1;
            }
            if (a.columnOrder > b.columnOrder || typeof a.columnOrder === 'undefined') {
                return 1;
            }
            return 0;
        };
        /**
         * Sort by length
         */
        this.getOrderByLength = function (a, b) {
            return b.length - a.length;
        };
        /**
         * Return property
         */
        this.getProperty = function (array, key) {
            for (var /** @type {?} */ i = 0; i < array.length; i++) {
                if (array[i].objectKey === key) {
                    return array[i];
                }
            }
        };
    }
    /**
     * @param {?} row
     * @param {?} settings
     * @param {?} fields
     * @param {?} updated
     * @param {?} loading
     * @param {?=} highlight
     * @param {?=} searchString
     * @return {?}
     */
    GtRenderPipe.prototype.transform = /**
     * @param {?} row
     * @param {?} settings
     * @param {?} fields
     * @param {?} updated
     * @param {?} loading
     * @param {?=} highlight
     * @param {?=} searchString
     * @return {?}
     */
    function (row, settings, fields, updated, loading, highlight, searchString) {
        if (highlight === void 0) { highlight = false; }
        // let arr = [{"temp":123,"name":"happy"},{"temp":456,"name":"dfgdfg"},{"temp":789,"name":"asdasd"}];
        // console.log(arr,arr.map(function(item){return item.temp}));
        // console.log(settings.map('objectKey'));
        // console.log('render');
        var /** @type {?} */ columns = [];
        for (var /** @type {?} */ i = 0; i < settings.length; i++) {
            if (settings[i].visible !== false && settings[i].enabled !== false) {
                columns.push(settings[i].objectKey);
            }
        }
        for (var /** @type {?} */ i = 0; i < fields.length; i++) {
            // console.log(!row[fields[i].objectKey]);
            if (fields[i].value &&
                typeof fields[i].value === 'function' &&
                !row.hasOwnProperty(fields[i].objectKey)) {
                row[fields[i].objectKey] = loading ? '' : fields[i].value(row);
            }
        }
        // console.log(row);
        var /** @type {?} */ keys = [];
        for (var /** @type {?} */ key in row) {
            // console.log(key);
            if (columns.indexOf(key) !== -1) {
                var /** @type {?} */ fieldSetting = void 0;
                for (var /** @type {?} */ i = 0; i < fields.length; i++) {
                    if (fields[i].objectKey === key) {
                        fieldSetting = fields[i];
                        // console.log(fieldSetting);
                    }
                }
                var /** @type {?} */ columnObject = {
                    objectKey: key,
                    sortValue: row[key]
                };
                // add component if defined
                if (fieldSetting.columnComponent) {
                    columnObject.columnComponent = fieldSetting.columnComponent;
                }
                if (loading) {
                    columnObject.renderValue = row[key] !== null ? row[key] : '';
                }
                else if (highlight &&
                    searchString &&
                    this.getProperty(settings, key).search !== false) {
                    columnObject.renderValue =
                        fieldSetting.render && typeof fieldSetting.render === 'function'
                            ? this.gtHighlightPipe.transform(fieldSetting.render(row), searchString)
                            : this.gtHighlightPipe.transform(row[key] !== null ? row[key] : '', searchString);
                }
                else {
                    columnObject.renderValue =
                        fieldSetting.render && typeof fieldSetting.render === 'function'
                            ? this.sanitizer.bypassSecurityTrustHtml(fieldSetting.render(row))
                            : row[key] !== null
                                ? row[key]
                                : '';
                }
                if (fieldSetting.click && typeof fieldSetting.click === 'function') {
                    columnObject.click = fieldSetting.click;
                }
                if (fieldSetting.expand) {
                    columnObject.expand = fieldSetting.expand;
                }
                keys.push(columnObject);
            }
        }
        keys.sort(function (a, b) {
            return columns.indexOf(a.objectKey) < columns.indexOf(b.objectKey)
                ? -1
                : 1;
        });
        return keys;
    };
    GtRenderPipe.decorators = [
        { type: Pipe, args: [{
                    name: 'gtRender'
                },] },
    ];
    /** @nocollapse */
    GtRenderPipe.ctorParameters = function () { return [
        { type: DomSanitizer, },
        { type: GtHighlightPipe, },
    ]; };
    return GtRenderPipe;
}());
export { GtRenderPipe };
function GtRenderPipe_tsickle_Closure_declarations() {
    /** @type {!Array<{type: !Function, args: (undefined|!Array<?>)}>} */
    GtRenderPipe.decorators;
    /**
     * @nocollapse
     * @type {function(): !Array<(null|{type: ?, decorators: (undefined|!Array<{type: !Function, args: (undefined|!Array<?>)}>)})>}
     */
    GtRenderPipe.ctorParameters;
    /**
     * Sort by column order
     * @type {?}
     */
    GtRenderPipe.prototype.getColumnOrder;
    /**
     * Sort by length
     * @type {?}
     */
    GtRenderPipe.prototype.getOrderByLength;
    /**
     * Return property
     * @type {?}
     */
    GtRenderPipe.prototype.getProperty;
    /** @type {?} */
    GtRenderPipe.prototype.sanitizer;
    /** @type {?} */
    GtRenderPipe.prototype.gtHighlightPipe;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3QtcmVuZGVyLnBpcGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYW5ndWxhci1nZW5lcmljLXRhYmxlL2NvcmUvIiwic291cmNlcyI6WyJwaXBlcy9ndC1yZW5kZXIucGlwZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLElBQUksRUFBaUIsTUFBTSxlQUFlLENBQUM7QUFHcEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBR3pELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQzs7Ozs7O0lBTXJELHNCQUNTLFdBQ0E7UUFEQSxjQUFTLEdBQVQsU0FBUztRQUNULG9CQUFlLEdBQWYsZUFBZTs7Ozs4QkFLQyxVQUFTLENBQWtCLEVBQUUsQ0FBa0I7WUFDdkUsSUFBSSxDQUFDLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyxXQUFXLEVBQUU7Z0JBQ2xDLE9BQU8sQ0FBQyxDQUFDLENBQUM7YUFDVjtZQUNELElBQUksQ0FBQyxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUMsV0FBVyxJQUFJLE9BQU8sQ0FBQyxDQUFDLFdBQVcsS0FBSyxXQUFXLEVBQUU7Z0JBQzFFLE9BQU8sQ0FBQyxDQUFDO2FBQ1Q7WUFDRCxPQUFPLENBQUMsQ0FBQztTQUNUOzs7O2dDQUcwQixVQUFTLENBQU0sRUFBRSxDQUFNO1lBQ2pELE9BQU8sQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO1NBQzNCOzs7OzJCQUdxQixVQUFTLEtBQWlCLEVBQUUsR0FBVztZQUM1RCxLQUFLLHFCQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQ3RDLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsS0FBSyxHQUFHLEVBQUU7b0JBQy9CLE9BQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNoQjthQUNE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Q0wsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxJQUFJLENBQUM7S0FDWjs7Z0JBcElELElBQUksU0FBQztvQkFDTCxJQUFJLEVBQUUsVUFBVTtpQkFDaEI7Ozs7Z0JBUFEsWUFBWTtnQkFHWixlQUFlOzt1QkFOeEI7O1NBV2EsWUFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBpcGUsIFBpcGVUcmFuc2Zvcm0gfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgR3RDb25maWdTZXR0aW5nIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9ndC1jb25maWctc2V0dGluZyc7XHJcbmltcG9ydCB7IEd0Q29uZmlnRmllbGQgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2d0LWNvbmZpZy1maWVsZCc7XHJcbmltcG9ydCB7IERvbVNhbml0aXplciB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xyXG5pbXBvcnQgeyBHdFJvdyB9IGZyb20gJy4uL2ludGVyZmFjZXMvZ3Qtcm93JztcclxuaW1wb3J0IHsgR3RSZW5kZXJGaWVsZCB9IGZyb20gJy4uL2ludGVyZmFjZXMvZ3QtcmVuZGVyLWZpZWxkJztcclxuaW1wb3J0IHsgR3RIaWdobGlnaHRQaXBlIH0gZnJvbSAnLi9ndC1oaWdobGlnaHQucGlwZSc7XHJcblxyXG5AUGlwZSh7XHJcblx0bmFtZTogJ2d0UmVuZGVyJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgR3RSZW5kZXJQaXBlPFIgZXh0ZW5kcyBHdFJvdz4gaW1wbGVtZW50cyBQaXBlVHJhbnNmb3JtIHtcclxuXHRjb25zdHJ1Y3RvcihcclxuXHRcdHByaXZhdGUgc2FuaXRpemVyOiBEb21TYW5pdGl6ZXIsXHJcblx0XHRwcml2YXRlIGd0SGlnaGxpZ2h0UGlwZTogR3RIaWdobGlnaHRQaXBlXHJcblx0KSB7fVxyXG5cclxuXHQvLyBUT0RPOiBtb3ZlIHRvIGhlbHBlciBmdW5jdGlvbnNcclxuXHQvKiogU29ydCBieSBjb2x1bW4gb3JkZXIgKi9cclxuXHRwcml2YXRlIGdldENvbHVtbk9yZGVyID0gZnVuY3Rpb24oYTogR3RDb25maWdTZXR0aW5nLCBiOiBHdENvbmZpZ1NldHRpbmcpIHtcclxuXHRcdGlmIChhLmNvbHVtbk9yZGVyIDwgYi5jb2x1bW5PcmRlcikge1xyXG5cdFx0XHRyZXR1cm4gLTE7XHJcblx0XHR9XHJcblx0XHRpZiAoYS5jb2x1bW5PcmRlciA+IGIuY29sdW1uT3JkZXIgfHwgdHlwZW9mIGEuY29sdW1uT3JkZXIgPT09ICd1bmRlZmluZWQnKSB7XHJcblx0XHRcdHJldHVybiAxO1xyXG5cdFx0fVxyXG5cdFx0cmV0dXJuIDA7XHJcblx0fTtcclxuXHJcblx0LyoqIFNvcnQgYnkgbGVuZ3RoICovXHJcblx0cHJpdmF0ZSBnZXRPcmRlckJ5TGVuZ3RoID0gZnVuY3Rpb24oYTogYW55LCBiOiBhbnkpIHtcclxuXHRcdHJldHVybiBiLmxlbmd0aCAtIGEubGVuZ3RoO1xyXG5cdH07XHJcblxyXG5cdC8qKiBSZXR1cm4gcHJvcGVydHkgKi9cclxuXHRwcml2YXRlIGdldFByb3BlcnR5ID0gZnVuY3Rpb24oYXJyYXk6IEFycmF5PGFueT4sIGtleTogc3RyaW5nKSB7XHJcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7XHJcblx0XHRcdGlmIChhcnJheVtpXS5vYmplY3RLZXkgPT09IGtleSkge1xyXG5cdFx0XHRcdHJldHVybiBhcnJheVtpXTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cdH07XHJcblxyXG5cdHRyYW5zZm9ybShcclxuXHRcdHJvdzogYW55LFxyXG5cdFx0c2V0dGluZ3M6IEFycmF5PEd0Q29uZmlnU2V0dGluZz4sXHJcblx0XHRmaWVsZHM6IEFycmF5PEd0Q29uZmlnRmllbGQ8UiwgYW55Pj4sXHJcblx0XHR1cGRhdGVkOiBib29sZWFuLFxyXG5cdFx0bG9hZGluZzogYm9vbGVhbixcclxuXHRcdGhpZ2hsaWdodDogYm9vbGVhbiA9IGZhbHNlLFxyXG5cdFx0c2VhcmNoU3RyaW5nPzogc3RyaW5nXHJcblx0KTogQXJyYXk8R3RSZW5kZXJGaWVsZDxSLCBhbnk+PiB7XHJcblx0XHQvLyBsZXQgYXJyID0gW3tcInRlbXBcIjoxMjMsXCJuYW1lXCI6XCJoYXBweVwifSx7XCJ0ZW1wXCI6NDU2LFwibmFtZVwiOlwiZGZnZGZnXCJ9LHtcInRlbXBcIjo3ODksXCJuYW1lXCI6XCJhc2Rhc2RcIn1dO1xyXG5cdFx0Ly8gY29uc29sZS5sb2coYXJyLGFyci5tYXAoZnVuY3Rpb24oaXRlbSl7cmV0dXJuIGl0ZW0udGVtcH0pKTtcclxuXHRcdC8vIGNvbnNvbGUubG9nKHNldHRpbmdzLm1hcCgnb2JqZWN0S2V5JykpO1xyXG5cclxuXHRcdC8vIGNvbnNvbGUubG9nKCdyZW5kZXInKTtcclxuXHRcdGNvbnN0IGNvbHVtbnM6IEFycmF5PHN0cmluZz4gPSBbXTtcclxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgc2V0dGluZ3MubGVuZ3RoOyBpKyspIHtcclxuXHRcdFx0aWYgKHNldHRpbmdzW2ldLnZpc2libGUgIT09IGZhbHNlICYmIHNldHRpbmdzW2ldLmVuYWJsZWQgIT09IGZhbHNlKSB7XHJcblx0XHRcdFx0Y29sdW1ucy5wdXNoKHNldHRpbmdzW2ldLm9iamVjdEtleSk7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHJcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGZpZWxkcy5sZW5ndGg7IGkrKykge1xyXG5cdFx0XHQvLyBjb25zb2xlLmxvZyghcm93W2ZpZWxkc1tpXS5vYmplY3RLZXldKTtcclxuXHRcdFx0aWYgKFxyXG5cdFx0XHRcdGZpZWxkc1tpXS52YWx1ZSAmJlxyXG5cdFx0XHRcdHR5cGVvZiBmaWVsZHNbaV0udmFsdWUgPT09ICdmdW5jdGlvbicgJiZcclxuXHRcdFx0XHQhcm93Lmhhc093blByb3BlcnR5KGZpZWxkc1tpXS5vYmplY3RLZXkpXHJcblx0XHRcdCkge1xyXG5cdFx0XHRcdHJvd1tmaWVsZHNbaV0ub2JqZWN0S2V5XSA9IGxvYWRpbmcgPyAnJyA6IGZpZWxkc1tpXS52YWx1ZShyb3cpO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0XHQvLyBjb25zb2xlLmxvZyhyb3cpO1xyXG5cdFx0Y29uc3Qga2V5czogQXJyYXk8YW55PiA9IFtdO1xyXG5cdFx0Zm9yIChjb25zdCBrZXkgaW4gcm93KSB7XHJcblx0XHRcdC8vIGNvbnNvbGUubG9nKGtleSk7XHJcblx0XHRcdGlmIChjb2x1bW5zLmluZGV4T2Yoa2V5KSAhPT0gLTEpIHtcclxuXHRcdFx0XHRsZXQgZmllbGRTZXR0aW5nO1xyXG5cdFx0XHRcdGZvciAobGV0IGkgPSAwOyBpIDwgZmllbGRzLmxlbmd0aDsgaSsrKSB7XHJcblx0XHRcdFx0XHRpZiAoZmllbGRzW2ldLm9iamVjdEtleSA9PT0ga2V5KSB7XHJcblx0XHRcdFx0XHRcdGZpZWxkU2V0dGluZyA9IGZpZWxkc1tpXTtcclxuXHRcdFx0XHRcdFx0Ly8gY29uc29sZS5sb2coZmllbGRTZXR0aW5nKTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdGNvbnN0IGNvbHVtbk9iamVjdDogR3RSZW5kZXJGaWVsZDxSLCBhbnk+ID0ge1xyXG5cdFx0XHRcdFx0b2JqZWN0S2V5OiBrZXksXHJcblx0XHRcdFx0XHRzb3J0VmFsdWU6IHJvd1trZXldXHJcblx0XHRcdFx0fTtcclxuXHJcblx0XHRcdFx0Ly8gYWRkIGNvbXBvbmVudCBpZiBkZWZpbmVkXHJcblx0XHRcdFx0aWYgKGZpZWxkU2V0dGluZy5jb2x1bW5Db21wb25lbnQpIHtcclxuXHRcdFx0XHRcdGNvbHVtbk9iamVjdC5jb2x1bW5Db21wb25lbnQgPSBmaWVsZFNldHRpbmcuY29sdW1uQ29tcG9uZW50O1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0aWYgKGxvYWRpbmcpIHtcclxuXHRcdFx0XHRcdGNvbHVtbk9iamVjdC5yZW5kZXJWYWx1ZSA9IHJvd1trZXldICE9PSBudWxsID8gcm93W2tleV0gOiAnJztcclxuXHRcdFx0XHR9IGVsc2UgaWYgKFxyXG5cdFx0XHRcdFx0aGlnaGxpZ2h0ICYmXHJcblx0XHRcdFx0XHRzZWFyY2hTdHJpbmcgJiZcclxuXHRcdFx0XHRcdHRoaXMuZ2V0UHJvcGVydHkoc2V0dGluZ3MsIGtleSkuc2VhcmNoICE9PSBmYWxzZVxyXG5cdFx0XHRcdCkge1xyXG5cdFx0XHRcdFx0Y29sdW1uT2JqZWN0LnJlbmRlclZhbHVlID1cclxuXHRcdFx0XHRcdFx0ZmllbGRTZXR0aW5nLnJlbmRlciAmJiB0eXBlb2YgZmllbGRTZXR0aW5nLnJlbmRlciA9PT0gJ2Z1bmN0aW9uJ1xyXG5cdFx0XHRcdFx0XHRcdD8gdGhpcy5ndEhpZ2hsaWdodFBpcGUudHJhbnNmb3JtKFxyXG5cdFx0XHRcdFx0XHRcdFx0XHRmaWVsZFNldHRpbmcucmVuZGVyKHJvdyksXHJcblx0XHRcdFx0XHRcdFx0XHRcdHNlYXJjaFN0cmluZ1xyXG5cdFx0XHRcdFx0XHRcdCAgKVxyXG5cdFx0XHRcdFx0XHRcdDogdGhpcy5ndEhpZ2hsaWdodFBpcGUudHJhbnNmb3JtKFxyXG5cdFx0XHRcdFx0XHRcdFx0XHRyb3dba2V5XSAhPT0gbnVsbCA/IHJvd1trZXldIDogJycsXHJcblx0XHRcdFx0XHRcdFx0XHRcdHNlYXJjaFN0cmluZ1xyXG5cdFx0XHRcdFx0XHRcdCAgKTtcclxuXHRcdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdFx0Y29sdW1uT2JqZWN0LnJlbmRlclZhbHVlID1cclxuXHRcdFx0XHRcdFx0ZmllbGRTZXR0aW5nLnJlbmRlciAmJiB0eXBlb2YgZmllbGRTZXR0aW5nLnJlbmRlciA9PT0gJ2Z1bmN0aW9uJ1xyXG5cdFx0XHRcdFx0XHRcdD8gdGhpcy5zYW5pdGl6ZXIuYnlwYXNzU2VjdXJpdHlUcnVzdEh0bWwoZmllbGRTZXR0aW5nLnJlbmRlcihyb3cpKVxyXG5cdFx0XHRcdFx0XHRcdDogcm93W2tleV0gIT09IG51bGxcclxuXHRcdFx0XHRcdFx0XHRcdD8gcm93W2tleV1cclxuXHRcdFx0XHRcdFx0XHRcdDogJyc7XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRpZiAoZmllbGRTZXR0aW5nLmNsaWNrICYmIHR5cGVvZiBmaWVsZFNldHRpbmcuY2xpY2sgPT09ICdmdW5jdGlvbicpIHtcclxuXHRcdFx0XHRcdGNvbHVtbk9iamVjdC5jbGljayA9IGZpZWxkU2V0dGluZy5jbGljaztcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0aWYgKGZpZWxkU2V0dGluZy5leHBhbmQpIHtcclxuXHRcdFx0XHRcdGNvbHVtbk9iamVjdC5leHBhbmQgPSBmaWVsZFNldHRpbmcuZXhwYW5kO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0a2V5cy5wdXNoKGNvbHVtbk9iamVjdCk7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHJcblx0XHRrZXlzLnNvcnQoZnVuY3Rpb24oYTogYW55LCBiOiBhbnkpIHtcclxuXHRcdFx0cmV0dXJuIGNvbHVtbnMuaW5kZXhPZihhLm9iamVjdEtleSkgPCBjb2x1bW5zLmluZGV4T2YoYi5vYmplY3RLZXkpXHJcblx0XHRcdFx0PyAtMVxyXG5cdFx0XHRcdDogMTtcclxuXHRcdH0pO1xyXG5cdFx0cmV0dXJuIGtleXM7XHJcblx0fVxyXG59XHJcbiJdfQ==